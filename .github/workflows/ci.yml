name: CI

on:
  push:
    branches: [ main, develop, pre-develop ]
  pull_request:
    branches: [ main, develop, pre-develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -e '.[dev,test]'

      - name: Determine changed Python files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_sha='${{ github.event.pull_request.base.sha }}'
            head_sha='${{ github.sha }}'
          else
            git fetch --no-tags --depth=2 origin "${{ github.ref }}"
            base_sha="$(git rev-parse HEAD~1)"
            head_sha="${{ github.sha }}"
          fi
          echo "Base: $base_sha"
          echo "Head: $head_sha"
          files=$(git diff --name-only "$base_sha" "$head_sha" | grep -E '\\.py$' || true)
          echo "Changed Python files:\n$files"
          files_space=$(echo "$files" | tr '\n' ' ')
          echo "files=$files_space" >> "$GITHUB_OUTPUT"

      - name: Lint changed files with Ruff
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          ruff --version
          python - << 'PY'
          import os, sys, subprocess
          files = [f for f in os.environ.get('CHANGED_FILES','').split() if f.strip()]
          if not files:
              print('No Python changes detected; skipping Ruff.')
              sys.exit(0)
          cmd = ['ruff', 'check', '--output-format=github', *files]
          print('Running:', ' '.join(cmd))
          sys.exit(subprocess.run(cmd).returncode)
          PY
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}

      - name: Skip Ruff (no changed Python files)
        if: ${{ steps.changed.outputs.files == '' }}
        run: echo "No Python changes detected; skipping Ruff."

      - name: Import and initialize API
        run: |
          python - << 'PY'
          from src.api.main import create_app
          app = create_app()
          print('App initialized:', bool(app))
          PY

      - name: Run tests
        run: pytest -q
